# 文件存储系统重构文档

## 概述

本次重构将文件存储系统从数据库驱动转变为文件系统驱动的架构，提高了系统的可维护性、可扩展性和性能。

## 核心变更

### 1. 文件存储服务 (FileStorageService)

位置: `backend/services/fileSystemService.js`

主要功能：
- 管理所有文件和文件夹的物理存储
- 提供统一的路径构建方法
- 处理文件和文件夹的创建、删除、移动、恢复等操作
- 确保文件系统结构的一致性

### 2. 缓存服务 (CacheService)

位置: `backend/services/cacheService.js`

主要功能：
- 提供内存缓存机制
- 支持缓存失效策略
- 提供缓存统计功能
- 支持按类型、用户、文件夹清除缓存

### 3. 数据模型更新

#### File模型
- 移除了`path`字段
- 添加虚拟字段`path`，由文件存储服务动态生成
- 保持其他字段不变

#### Folder模型
- 移除了`path`字段
- 添加虚拟字段`path`，由文件存储服务动态生成
- 保持其他字段不变

### 4. API层更新

#### 文件操作API (fileRoutes.js)
- 文件上传：使用文件存储服务管理文件路径
- 文件下载：使用文件存储服务获取文件路径
- 文件删除：使用文件存储服务删除文件
- 文件恢复：使用文件存储服务恢复文件
- 文件移动：使用文件存储服务移动文件
- 文件类型切换：使用文件存储服务处理文件移动
- 所有操作都添加了缓存清除逻辑

#### 文件夹操作API (folderRoutes.js)
- 文件夹创建：使用文件存储服务创建文件夹
- 文件夹删除：使用文件存储服务删除文件夹
- 文件夹恢复：使用文件存储服务恢复文件夹
- 文件夹移动：使用文件存储服务移动文件夹
- 所有递归操作都使用文件存储服务
- 所有操作都添加了缓存清除逻辑

## 文件系统结构

```
uploads/
├── private/
│   └── [userId]/
│       ├── [folderId]/
│       │   └── [subFolderId]/
│       │       └── [fileId]
│       └── [fileId]
├── public/
│   └── [userId]/
│       └── [folderId]/
│           └── [fileId]
└── shared/
    └── [sharedFolderId]/
        └── [fileId]
```

## 数据迁移

### 迁移脚本

位置: `backend/scripts/migrateFileStorage.js`

### 迁移步骤

1. 备份现有数据
   ```bash
   # 备份数据库
   mongodump --db school_utility_tools --out backup/

   # 备份文件
   cp -r backend/uploads backup/
   ```

2. 运行迁移脚本
   ```bash
   cd backend
   node scripts/migrateFileStorage.js
   ```

3. 验证迁移结果
   - 检查文件是否正确移动到新位置
   - 验证数据库记录是否正确
   - 测试文件上传、下载等功能

## 性能优化

### 缓存策略

1. 文件列表缓存
   - 缓存键格式：`fileList:type:userId:parentId:page:limit`
   - 缓存时间：5分钟
   - 失效时机：文件或文件夹操作时

2. 缓存清除策略
   - 文件操作：清除所属文件夹和用户的缓存
   - 文件夹操作：清除该文件夹及其父文件夹、用户的缓存

### 文件系统优化

1. 路径构建优化
   - 统一的路径构建方法
   - 减少重复计算

2. 批量操作优化
   - 支持批量上传
   - 优化递归操作

## 注意事项

1. 路径动态生成
   - 文件和文件夹的路径不再存储在数据库中
   - 通过虚拟字段动态生成
   - 确保路径的一致性

2. 缓存一致性
   - 所有文件和文件夹操作都会清除相关缓存
   - 确保缓存与实际数据一致

3. 错误处理
   - 完善的错误处理机制
   - 详细的错误日志

## 后续优化方向

1. 引入Redis作为分布式缓存
2. 实现文件版本控制
3. 添加文件分享功能
4. 实现文件预览优化
5. 添加文件协作功能
